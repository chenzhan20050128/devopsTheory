# 代码修复总结

## 发现的主要问题

### 1. 标签生成逻辑错误（严重）
**问题**：`_backfill_labels` 函数使用反向遍历，逻辑不正确，导致：
- 只标记异常窗口之前的窗口，但逻辑混乱
- 对于没有异常的序列，所有窗口的 `y_mask` 都是 False，导致回归损失无法计算
- 验证集上 recall 为 0，说明标签生成有问题

**修复**：
- 改为前向查找：对每个窗口，检查未来 H 个窗口内是否有异常
- 所有窗口都设置 `y_mask=True`，确保回归损失对所有样本都计算
- 正确计算距离和权重

### 2. 模型架构问题
**问题**：
- 文本特征只使用平均池化，丢失重要信息
- 只使用序列最后一个时间步，没有充分利用序列信息

**修复**：
- 使用 mean + max 池化组合，增强文本特征表示
- 结合最后一个时间步和平均池化，获得更好的序列表示

### 3. 回归损失计算问题
**问题**：
- 只对正样本计算回归损失，负样本被忽略
- 导致模型无法学习"未来没有异常"的模式

**修复**：
- 对所有 mask=True 的样本计算回归损失
- 正样本使用全权重，负样本使用较低权重（0.1）

### 4. 训练策略问题
**问题**：
- 缺少学习率调度器
- 超参数可能不够优化

**修复**：
- 添加 ReduceLROnPlateau 调度器
- 调整学习率从 1e-3 到 5e-4，提高训练稳定性
- 增加训练轮数到 20
- 调整窗口参数以匹配基线配置

### 5. 数据分组和序列构建
**问题**：
- 序列构建的 stride 可能不够灵活
- 缺少数据统计输出

**修复**：
- 使用自适应 stride，根据组大小调整
- 添加详细的数据统计输出，包括正负样本比例

## 修复的文件

1. **data.py**：
   - 重写 `_backfill_labels` 函数
   - 改进 `build_sequences` 的 stride 策略
   - 确保时间排序

2. **model.py**：
   - 改进文本特征提取（mean + max pooling）
   - 改进序列表示（last + mean）
   - 修复 token_projection 维度

3. **train.py**：
   - 修复回归损失计算
   - 添加学习率调度器
   - 添加数据统计输出

4. **config.py**：
   - 调整超参数（学习率、轮数、窗口参数）

## 验证修复效果

运行训练后，检查以下指标：

1. **数据质量**：
   - 训练集、验证集、测试集都应该有数据
   - 正样本比例应该合理（通常 10-30%）

2. **训练过程**：
   - 验证集 recall@top 应该 > 0（之前为 0）
   - 回归损失应该 > 0（之前验证集为 0）
   - 损失应该逐渐下降

3. **最终指标**：
   - Recall@Top20% ≥ 0.80（目标）
   - RTF MAE ≤ 1.0（目标）
   - 平均提前量 ≥ 2.0 个窗口（目标）

## 建议的下一步

如果效果仍然不好，可以尝试：

1. **调整超参数**：
   - 增加 `alert_horizon`（如果数据允许）
   - 调整 `lambda_reg`（回归损失权重）
   - 调整 `focal_gamma` 和 `focal_alpha`

2. **数据增强**：
   - 检查数据质量，确保有足够的异常样本
   - 考虑数据平衡策略（过采样/欠采样）

3. **模型改进**：
   - 增加模型容量（hidden_dim, num_heads）
   - 尝试不同的序列聚合方式
   - 添加注意力机制可视化

4. **特征工程**：
   - 检查特征是否标准化
   - 添加更多统计特征
   - 考虑使用预训练的词向量

